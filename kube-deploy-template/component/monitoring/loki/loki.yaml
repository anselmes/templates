---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
spec:
  values:
    loki:
      config: |
        auth_enabled: false

        server:
          {{- toYaml .Values.loki.server | nindent 6 }}

        common:
          compactor_address: http://{{ include "loki.compactorFullname" . }}:3100

        distributor:
          ring:
            kvstore:
              store: memberlist

        memberlist:
          cluster_label: "{{ .Release.Name }}.{{ .Release.Namespace }}"
          join_members:
            - {{ include "loki.fullname" . }}-memberlist

        ingester_client:
          grpc_client_config:
            grpc_compression: gzip

        ingester:
          lifecycler:
            ring:
              kvstore:
                store: memberlist
              replication_factor: 1
          chunk_idle_period: 30m
          chunk_block_size: 262144
          chunk_encoding: snappy
          chunk_retain_period: 1m
          wal:
            dir: /var/loki/wal

        pattern_ingester:
          enabled: true

        limits_config:
          allow_structured_metadata: true
          volume_enabled: true
          reject_old_samples: true
          reject_old_samples_max_age: 168h
          max_cache_freshness_per_query: 10m
          split_queries_by_interval: 15m

        {{- if .Values.loki.schemaConfig}}
        schema_config:
        {{- toYaml .Values.loki.schemaConfig | nindent 2}}
        {{- end}}
        {{- if .Values.loki.storageConfig}}
        storage_config:
        {{- if .Values.indexGateway.enabled}}
        {{- $indexGatewayClient := dict "server_address" (printf "dns:///%s:9095" (include "loki.indexGatewayFullname" .)) }}
        {{- $_ := set .Values.loki.storageConfig.boltdb_shipper "index_gateway_client" $indexGatewayClient }}
        {{- end}}
        {{- toYaml .Values.loki.storageConfig | nindent 2}}
        {{- if .Values.memcachedIndexQueries.enabled }}
          index_queries_cache_config:
            memcached_client:
              addresses: dnssrv+_memcached-client._tcp.{{ include "loki.memcachedIndexQueriesFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}
              consistent_hash: true
        {{- end}}
        {{- end}}

        runtime_config:
          file: /var/{{ include "loki.name" . }}-runtime/runtime.yaml

        chunk_store_config:
          {{- if .Values.memcachedChunks.enabled }}
          chunk_cache_config:
            embedded_cache:
              enabled: false
            memcached_client:
              consistent_hash: true
              addresses: dnssrv+_memcached-client._tcp.{{ include "loki.memcachedChunksFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}
          {{- end }}
          {{- if .Values.memcachedIndexWrites.enabled }}
          write_dedupe_cache_config:
            memcached_client:
              consistent_hash: true
              addresses: dnssrv+_memcached-client._tcp.{{ include "loki.memcachedIndexWritesFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}
          {{- end }}

        table_manager:
          retention_deletes_enabled: false
          retention_period: 0s

        query_range:
          align_queries_with_step: true
          max_retries: 5
          cache_results: true
          results_cache:
            cache:
              {{- if .Values.memcachedFrontend.enabled }}
              memcached_client:
                addresses: dnssrv+_memcached-client._tcp.{{ include "loki.memcachedFrontendFullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.global.clusterDomain }}
                consistent_hash: true
              {{- else }}
              embedded_cache:
                enabled: true
                ttl: 24h
              {{- end }}

        frontend_worker:
          {{- if .Values.queryScheduler.enabled }}
          scheduler_address: {{ include "loki.querySchedulerFullname" . }}:9095
          {{- else }}
          frontend_address: {{ include "loki.queryFrontendFullname" . }}-headless:9095
          {{- end }}

        frontend:
          log_queries_longer_than: 5s
          compress_responses: true
          {{- if .Values.queryScheduler.enabled }}
          scheduler_address: {{ include "loki.querySchedulerFullname" . }}:9095
          {{- end }}
          tail_proxy_url: http://{{ include "loki.querierFullname" . }}:3100

        compactor:
          working_directory: /var/loki/compactor

        ruler:
          storage:
            type: local
            local:
              directory: /etc/loki/rules
          ring:
            kvstore:
              store: memberlist
          rule_path: /tmp/loki/scratch
          alertmanager_url: http://alertmanager-operated
          external_url: http://alertmanager-operated
